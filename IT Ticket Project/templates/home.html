{% extends "base.html" %}

{% block title %}Tickets - IT Ticketing System{% endblock %}

{% block content %}

<section>

    <!-- Header + Primary Action -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0">
            <i class="bi bi-list-task"></i> Tickets
        </h2>
        <a href="{{ url_for('tickets.create_ticket_route') }}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> New Ticket
        </a>
    </div>

    <!-- ==================== FILTER FORM ==================== -->
    <form method="GET" class="row g-3 mb-4">

        <!-- Search -->
        <div class="col-md-4">
            <label for="search_input" class="visually-hidden">Search tickets</label>
            <input type="text"
                   id="search_input"
                   class="form-control"
                   name="search"
                   value="{{ request.args.get('search', '') }}"
                   placeholder="Search by title or description...">
        </div>

        <!-- Status -->
        <div class="col-md-3">
            <label for="filter_status" class="visually-hidden">Filter by Status</label>
            <select id="filter_status" name="filter_status" class="form-select form-select-sm">
                <option value="">All</option>
                {% for s in STATUSES %}
                    <option value="{{ s }}"
                        {% if request.args.get('filter_status') == s %}selected{% endif %}>
                        {{ s }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Sort -->
        <div class="col-md-3">
            <label for="sort_by" class="visually-hidden">Sort by</label>
            <select id="sort_by" name="sort_by" class="form-select form-select-sm">
                <option value="">Sort</option>
                {% for field, label in {
                    'priority': 'Priority',
                    'created_at': 'Date Created'
                }.items() %}
                    <option value="{{ field }}"
                        {% if request.args.get('sort_by') == field %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Submit -->
        <div class="col-md-2">
            <button type = "submit" class="btn btn-primary w-100" title="Apply Filters">
                Apply
            </button>
        </div>
    </form>

    <!-- ==================== TABLE ==================== -->
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Title</th>
                    <th scope="col">Description</th>
                    <th scope="col">Priority</th>
                    <th scope="col">Status</th>
                    <th scope="col">Created</th>
                    <th scope="col">Updated</th>
                    <th scope="col" class="text-end">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% if tickets %}
                    {% for t in tickets %}
                        <tr>
                            <td>{{ t.id }}</td>
                            <td class="fw-semibold">{{ t.title }}</td>

                            <td>
                                {{ t.description|truncate(80, end='...') }}
                            </td>

                            <!-- Priority Badge -->
                            <td>
                                {% set priority_colors = {
                                    'High': 'danger',
                                    'Medium': 'warning',
                                    'Low': 'secondary'
                                } %}
                                <span class="badge bg-{{ priority_colors.get(t.priority, 'secondary') }}">
                                    {{ t.priority }}
                                </span>
                            </td>

                            <!-- Status Badge -->
                            <td>
                                {% set status_colors = {
                                    'Open': 'primary',
                                    'In Progress': 'warning',
                                    'Closed': 'secondary'
                                } %}
                                <span class="badge bg-{{ status_colors.get(t.status, 'secondary') }}">
                                    {{ t.status }}
                                </span>
                            </td>

                            <td>{{ t.created_at }}</td>
                            <td>{{ t.updated_at }}</td>

                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('tickets.update_ticket_route', ticket_id=t.id) }}"
                                       class="btn btn-warning"
                                       title="Edit Ticket #{{ t.id }}">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>

                                    <form action="{{ url_for('tickets.delete_ticket_route', ticket_id=t.id) }}"
                                          method="POST"
                                          onsubmit="return confirm('Delete ticket #{{ t.id }}?')">
                                        <button type="submit" class="btn btn-danger" title="Delete Ticket">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inboxes"></i> No tickets found.
                        </td>
                    </tr>
                {% endif %}
            </tbody>

        </table>
    </div>

<!-- ==================== PAGINATION ==================== -->

   {%- if total_pages > 1 -%}
    {% set args = {
        'search': request.args.get('search',''),
        'filter_status': request.args.get('filter_status',''),
        'sort_by': request.args.get('sort_by','')
    } %}
    <nav aria-label="Ticket pagination">
        <ul class="pagination justify-content-center mb-0">{% for p in range(1, total_pages + 1) -%}
            <li class="page-item {% if p == current_page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('tickets.home', page=p, **args) }}" aria-label="Go to page {{ p }}">{{ p }}</a>
            </li>
        {%- endfor %}</ul>
    </nav>
    {%- endif -%}

</section>

{% endblock %}
